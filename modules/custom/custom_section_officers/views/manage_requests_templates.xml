<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Sidebar entry (in Section Officer module) -->
    <template id="hrmis_ui_layout_section_officer_manage_requests" inherit_id="hr_holidays_updates.hrmis_ui_layout">
        <xpath expr="//nav[contains(@class,'hrmis-nav')]" position="inside">
        <t t-if=" request.env.user.has_group('custom_login.group_section_officer')">
            <a t-attf-class="hrmis-nav__item #{'is-active' if active_menu == 'manage_requests' else ''}"
               href="/hrmis/manage/requests?tab=leave">
                Leave Requests
                <t t-if="pending_manage_leave_count and pending_manage_leave_count &gt; 0">
                    <span class="hrmis-nav__badge2"><t t-esc="pending_manage_leave_count"/></span>
                </t>
            </a>

            </t>
              <t t-if=" request.env.user.has_group('custom_login.group_section_officer')">
            <a t-attf-class="hrmis-nav__item" 
               href="#">
                Disciplinary Actions
                </a>
            </t>
            <t t-if="
                 request.env.user.has_group('custom_login.group_section_officer')
                ">
                <a t-attf-class="hrmis-nav__item #{'is-active' if active_menu == 'profile_update_requests' else ''}"
                    href="/hrmis/profile-update-requests">
                        Profile Update Requests
                </a>
            </t>
        </xpath>
    </template>

    <template id="hrmis_manage_requests" name="HRMIS Manage Requests (Section Officer)">
        <t t-call="hr_holidays_updates.hrmis_ui_layout">
            <div class="hrmis-panel">
                <t t-if="success or error">
                    <div t-attf-class="hrmis-alert #{'hrmis-alert--success' if success else 'hrmis-alert--error'}"
                        style="margin:5px; border: 2px solid black;font-weight:bold;">
                        <t t-esc="success or error"/>
                    </div>
                </t>
                <div class="hrmis-panel_header hrmis-panelheader--tabs hrmis-panel_header--tabs--manage">
                    <a t-attf-class="hrmis-tab hrmis-tab--manage is-active"
                       t-att-href="'/hrmis/manage/requests?tab=leave'" style="border-bottom: 2px solid black;">
                        Leave Requests
                    </a>
                </div>

                <div class="hrmis-panel__body">

                    <!-- Leave Requests -->
                    <t t-if="tab == 'leave'">
                        <t t-if="not leaves">
                            <div class="hrmis-empty">No leave requests pending your action.</div>
                        </t>
                        <t t-else="">
                            <t t-set="grid" t-value="'display:grid; grid-template-columns: 25px 2.0fr 130px 1.1fr 100px 100px 3.0fr; column-gap: 12px; align-items: start;'"/>
                            <div class="hrmis-table__head hrmis-leave-row hrmis-manage-table"
                                 t-att-style="grid + 'font-size: 12px; font-weight: 600; white-space: nowrap;'">
                                <div style="width:36px; max-width:36px;">#</div>
                                <div>Staff / Facility / District</div>
                                <div>Total Leave Balance</div>
                                <div>Submitted On</div>
                                <div>Leave Type</div>
                                <div>Dates</div>
                                <div style="white-space: nowrap;">Comments / Actions</div>
                            </div>
                            <t t-foreach="range(len(leaves))" t-as="idx0">
                                <t t-set="lv" t-value="leaves[idx0]" />
                                <div class="hrmis-leave-row hrmis-manage-table__row"
                                     t-att-style="grid + 'font-size: 12px;'"  t-att-href="'/hrmis/manage/history/%s?tab=leave' % (lv.employee_id.id)" style="cursor:pointer;">
                                    <!-- Serial Number -->
                                    <div class="hrmis-leave-row_cell hrmis-leave-row_sno" style="width:36px; max-width:36px;">
                                        <t t-esc="idx0 + 1" t-att-href="'/hrmis/manage/history/%s?tab=leave' % (lv.employee_id.id)" style="cursor:pointer;"/>
                                    </div>

                                    <!-- Employee / Facility / District -->
                                    <div class="hrmis-leave-row__cell">
                                        <div class="strong">
                                            <t t-esc="lv.employee_id.name" t-att-href="'/hrmis/manage/history/%s?tab=leave' % (lv.employee_id.id)" style="cursor:pointer;" />,
                                            <t t-esc="(('facility_id' in lv.employee_id._fields and lv.employee_id.facility_id and lv.employee_id.facility_id.name) or ('hrmis_facility_id' in lv.employee_id._fields and lv.employee_id.hrmis_facility_id and lv.employee_id.hrmis_facility_id.name) or 'Facility name')" t-att-href="'/hrmis/manage/history/%s?tab=leave' % (lv.employee_id.id)" style="cursor:pointer;"/>
                                        </div>
                                        <div class="sub">
                                            <t t-esc="(('district_id' in lv.employee_id._fields and lv.employee_id.district_id and lv.employee_id.district_id.name) or ('hrmis_district_id' in lv.employee_id._fields and lv.employee_id.hrmis_district_id and lv.employee_id.hrmis_district_id.name) or 'District name')" t-att-href="'/hrmis/manage/history/%s?tab=leave' % (lv.employee_id.id)" style="cursor:pointer;" />
                                        </div>
                                    </div>

                                    <!-- Leave Type -->
                                    <div class="hrmis-leave-row__cell">
                                        <t t-esc="lv.holiday_status_id.name"/>
                                    </div>

                                    <!-- Total Leave Balance -->
                                    <div class="hrmis-leave-row__cell">
                                        <t t-esc="(lv.employee_id.employee_leave_balance_total if lv.employee_id else 0.0)"/> days
                                    </div>

                                    <!-- Submitted On -->
                                    <div class="hrmis-leave-row__cell">
                                        <t t-esc="(str(lv.create_date)[:19] if lv.create_date else '')"/>
                                    </div>

                                    <!-- Dates -->
                                    <div class="hrmis-leave-row__cell">
                                        <t t-set="d_from" t-value="lv.request_date_from"/>
                                        <t t-set="d_to" t-value="lv.request_date_to"/>
                                        <t t-set="days_count" t-value="(d_to and d_from and ((d_to - d_from).days + 1)) or 0"/>
                                        <t t-set="from_txt" t-value="(d_from and ('%s-%s-%s' % (d_from.day, d_from.month, d_from.year))) or ''"/>
                                        <t t-set="to_txt" t-value="(d_to and ('%s-%s-%s' % (d_to.day, d_to.month, d_to.year))) or ''"/>
                                        <t t-esc="from_txt"/> to <t t-esc="to_txt"/>
                                        <t t-if="days_count">
                                            (<t t-esc="days_count"/> <t t-esc="'day' if days_count == 1 else 'days'"/>)
                                        </t>
                                    </div>

                                    <!-- COMMENTS + ACTIONS -->
                                    <div class="hrmis-leave-row__actions" style="display:grid; gap:8px;">

                                       

                                        <!-- Previous approvers comments -->
                                        <t t-if="lv.message_ids and len(lv.message_ids)">
                                            <div class="hrmis-comments" style="padding:4px 0; max-height:120px; overflow-y:auto; border-bottom:1px solid #eee;">
                                                <t t-foreach="lv.message_ids" t-as="msg">
                                                    <div class="hrmis-comment" style="font-size:12px; line-height:1.3; margin-bottom:4px;">
                                                        <strong><t t-esc="msg.author_id.name"/></strong>:
                                                        <t t-esc="msg.body"/>
                                                    </div>
                                                </t>
                                            </div>
                                        </t>

                                        <a class="hrmis-btn hrmis-btn--outline"
                                           style="width: fit-content;">
                                           Proceed
                                        </a>



                                    </div>
                                </div>
                             
                            </t>
                        </t>
                    </t>

                </div>
            </div>
        </t>
    </template>

    <template id="hrmis_manage_history" name="HRMIS Manage History (Section Officer)">
        <t t-call="hr_holidays_updates.hrmis_ui_layout">
            <div class="hrmis-panel">
                <div class="hrmis-panel__header hrmis-panel__header--tabs hrmis-panel__header--tabs--manage">
                    <a t-attf-class="hrmis-tab hrmis-tab--manage #{'is-active' if tab == 'leave' else ''}"
                       t-att-href="'/hrmis/manage/history/%s?tab=leave' % employee.id">
                        Leave Requests History
                    </a>
                    <a t-attf-class="hrmis-tab hrmis-tab--manage #{'is-active' if tab == 'transfer' else ''}"
                       t-att-href="'/hrmis/manage/history/%s?tab=transfer' % employee.id">
                        Transfer Requests History
                    </a>
                    <a t-attf-class="hrmis-tab hrmis-tab--manage #{'is-active' if tab == 'disciplinary' else ''}"
                       t-att-href="'/hrmis/manage/history/%s?tab=disciplinary' % employee.id">
                        Disciplinary Actions History
                    </a>
                </div>

                <div class="hrmis-panel__body">
                    <div style="margin-bottom: 18px; font-weight: 900; font-size: 15px;gap:12px">
                        <div>Name:<t t-esc="employee.name"/></div> <div>Facility:
                        <t t-if="facility_name">, <t t-esc="facility_name"/></t> </div><div>District:
                        <t t-if="district_name">, <t t-esc="district_name"/></t></div>
                       <div> 
                            Total Leave Balance:
                            <t t-esc="employee.employee_leave_balance_total or 0.0"/> days
                       </div>
                    </div>

                    <t t-if="tab == 'leave'">
                        <t t-if="not leaves_history">
                            <div class="hrmis-empty">No leave history found for this employee.</div>
                        </t>
                        <t t-else="">
                            <t t-set="grid_hist" t-value="'display:grid; grid-template-columns: 1.6fr 170px 1.1fr 1.1fr 0.9fr 1fr; column-gap: 12px; align-items: start;'"/>
                            <div class="hrmis-table__head"
                                 t-att-style="grid_hist + 'font-size: 18px; font-weight: 900; white-space: nowrap; padding-block: 12px;'">
                                <div>Leave Type</div>
                                <div>Submitted On</div>
                                <div>From</div>
                                <div>To</div>
                                <div>Leave Taken</div>
                                <div>Status</div>
                            </div>
                            <t t-foreach="leaves_history" t-as="lv">
                                <div class="hrmis-table__row" t-att-style="grid_hist + 'font-size: 15px; margin-top: 8px border-bottom:1px solid #eee;'">
                                    <div><t t-esc="lv.holiday_status_id.name"/></div>
                                    <div><t t-esc="(str(lv.create_date)[:19] if lv.create_date else '')"/></div>
                                    <div><t t-esc="lv.request_date_from or ''"/></div>
                                    <div><t t-esc="lv.request_date_to or ''"/></div>
                                    <div>
                                        <t t-esc="(leave_taken_by_type.get(lv.holiday_status_id.id, 0.0) if lv.holiday_status_id else 0.0)"/>
                                    </div>
                                    <div>
                                        <t t-if="lv.state in ('confirm','validate1')">Pending</t>
                                        <t t-elif="lv.state in ('validate','validate2')">Approved</t>
                                        <t t-elif="lv.state == 'refuse'">Rejected</t>
                                        <t t-else=""><t t-esc="lv.state"/></t>
                                    </div>
                                </div>
                            </t>
                        </t>
                    </t>

                    <t t-if="tab == 'transfer'">
                        <div class="hrmis-empty">No transfer requests history available yet.</div>
                    </t>

                    <t t-if="tab == 'disciplinary'">
                        <div class="hrmis-empty">No disciplinary actions history available yet.</div>
                    </t>

                    <div class="hrmis-form__actions" style="margin-top: 16px;">
                        <a class="hrmis-btn hrmis-btn--outline" href="/hrmis/manage/requests?tab=leave">Back to Manage Requests</a>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="hrmis_confirm_dismiss" name="HRMIS Confirm Dismiss (Section Officer)">
        <t t-call="hr_holidays_updates.hrmis_ui_layout">
            <div class="hrmis-panel">
                <div class="hrmis-panel__header">
                    <div class="hrmis-panel__title">Confirm dismiss</div>
                </div>
                <div class="hrmis-panel__body">
                    <div class="hrmis-kv">
                        <div class="hrmis-kv__row">
                            <div class="hrmis-kv__k">Type</div>
                            <div class="hrmis-kv__v">Leave request</div>
                        </div>
                        <div class="hrmis-kv__row">
                            <div class="hrmis-kv__k">Staff</div>
                            <div class="hrmis-kv__v"><t t-esc="record.employee_id.name"/></div>
                        </div>
                        <div class="hrmis-kv__row">
                            <div class="hrmis-kv__k">Dates</div>
                            <div class="hrmis-kv__v"><t t-esc="record.request_date_from"/> to <t t-esc="record.request_date_to"/></div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Override leave view "Back" when opened from Manage Requests -->
    <template id="hrmis_leave_view_back_section_officer" inherit_id="hr_holidays_updates.hrmis_leave_view">
        <xpath expr="//div[contains(@class,'hrmis-form__actions')]//a[contains(@class,'hrmis-btn') and contains(@class,'hrmis-btn--outline')][normalize-space()='Back']" position="attributes">
            <attribute name="t-att-href">'/hrmis/manage/requests?tab=leave' if active_menu == 'manage_requests' else '/hrmis/leave/requests'</attribute>
        </xpath>
    </template>
</odoo>