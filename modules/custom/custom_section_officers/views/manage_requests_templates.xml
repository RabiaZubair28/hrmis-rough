<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Sidebar entry (in Section Officer module) -->
    <template id="hrmis_ui_layout_section_officer_manage_requests" inherit_id="hr_holidays_updates.hrmis_ui_layout">
        <xpath expr="//nav[contains(@class,'hrmis-nav')]" position="inside">
        <t t-if=" request.env.user.has_group('custom_login.group_section_officer')">
            <a t-attf-class="hrmis-nav__item #{'is-active' if active_menu == 'manage_requests' else ''}"
               href="/hrmis/manage/requests?tab=leave">
                Manage Requests
            </a>
            </t>
              <t t-if=" request.env.user.has_group('custom_login.group_section_officer')">
            <a t-attf-class="hrmis-nav__item" 
               href="#">
                Initiate Disciplinary Actions
                </a>
            </t>
            <t t-if="
                 request.env.user.has_group('custom_login.group_section_officer')
                ">
                <a t-attf-class="hrmis-nav__item #{'is-active' if active_menu == 'profile_update_requests' else ''}"
                    href="/hrmis/profile-update-requests">
                        Profile Update Requests
                </a>
            </t>
        </xpath>
    </template>

    <template id="hrmis_manage_requests" name="HRMIS Manage Requests (Section Officer)">
        <t t-call="hr_holidays_updates.hrmis_ui_layout">
            <div class="hrmis-panel">
                <t t-if="success or error">
                    <div t-attf-class="hrmis-alert #{'hrmis-alert--success' if success else 'hrmis-alert--error'}"
                        style="margin-bottom:16px; padding:12px; border-radius:4px; font-weight:bold;">
                        <t t-esc="success or error"/>
                    </div>
                </t>
                <div class="hrmis-panel_header hrmis-panelheader--tabs hrmis-panel_header--tabs--manage">
                    <a t-attf-class="hrmis-tab hrmis-tab--manage is-active"
                       t-att-href="'/hrmis/manage/requests?tab=leave'" style="border-bottom: 2px solid black;">
                        Leave Requests
                    </a>
                </div>

                <div class="hrmis-panel__body">

                    <!-- Leave Requests -->
                    <t t-if="tab == 'leave'">
                        <t t-if="not leaves">
                            <div class="hrmis-empty">No leave requests pending your action.</div>
                        </t>
                        <t t-else="">
                            <div class="hrmis-table__head hrmis-leave-row hrmis-manage-table">
                                <div>#</div>
                                <div>Staff / Facility / District</div>
                                <div>Leave Type</div>
                                <div>Dates</div>
                                <div>Comments / Actions</div>
                            </div>
                            <t t-foreach="range(len(leaves))" t-as="idx0">
                                <t t-set="lv" t-value="leaves[idx0]"/>
                                <div class="hrmis-leave-row hrmis-manage-table__row">
                                    <!-- Serial Number -->
                                    <div class="hrmis-leave-row_cell hrmis-leave-row_sno">
                                        <t t-esc="idx0 + 1"/>
                                    </div>

                                    <!-- Employee / Facility / District -->
                                    <div class="hrmis-leave-row__cell">
                                        <div class="strong">
                                            <t t-esc="lv.employee_id.name"/>,
                                            <t t-esc="(('facility_id' in lv.employee_id._fields and lv.employee_id.facility_id and lv.employee_id.facility_id.name) or ('hrmis_facility_id' in lv.employee_id._fields and lv.employee_id.hrmis_facility_id and lv.employee_id.hrmis_facility_id.name) or 'Facility name')"/>
                                        </div>
                                        <div class="sub">
                                            <t t-esc="(('district_id' in lv.employee_id._fields and lv.employee_id.district_id and lv.employee_id.district_id.name) or ('hrmis_district_id' in lv.employee_id._fields and lv.employee_id.hrmis_district_id and lv.employee_id.hrmis_district_id.name) or 'District name')"/>
                                        </div>
                                    </div>

                                    <!-- Leave Type -->
                                    <div class="hrmis-leave-row__cell">
                                        <t t-esc="lv.holiday_status_id.name"/>
                                    </div>

                                    <!-- Dates -->
                                    <div class="hrmis-leave-row__cell">
                                        <t t-esc="lv.request_date_from"/> to <t t-esc="lv.request_date_to"/>
                                    </div>

                                    <!-- COMMENTS + ACTIONS -->
                                    <div class="hrmis-leave-row__actions" style="display:grid; gap:8px;">

                                        <!-- Previous approvers comments -->
                                        <t t-if="lv.message_ids and len(lv.message_ids)">
                                            <div class="hrmis-comments" style="padding:4px 0; max-height:120px; overflow-y:auto; border-bottom:1px solid #eee;">
                                                <t t-foreach="lv.message_ids" t-as="msg">
                                                    <div class="hrmis-comment" style="font-size:12px; line-height:1.3; margin-bottom:4px;">
                                                        <strong><t t-esc="msg.author_id.name"/></strong>:
                                                        <t t-esc="msg.body"/>
                                                    </div>
                                                </t>
                                            </div>
                                        </t>

                                        <form t-att-action="'/hrmis/leave/%s/action' % lv.id"
                                            method="post"
                                            style="display:flex; gap:8px; align-items:center;">
                                            <input type="text" name="comment"
                                                placeholder="Add comment..."
                                                style="flex:1; height:32px; border:1px solid #cfd7da; border-radius:4px; padding:0 8px;"/>
                                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                            <input type="hidden" name="action" value="approve"/>

                                            <button type="submit" class="hrmis-btn hrmis-btn--primary"
                                                    onclick="this.form.action.value = show_approve_text ? 'approve' : 'forward';">
                                                <t t-esc="show_approve_text and 'Approve' or 'Forward'"/>
                                            </button>


                                            <button type="submit" class="hrmis-btn hrmis-btn--outline"
                                                    onclick="this.form.action.value='dismiss';">
                                                Dismiss
                                            </button>
                                        </form>



                                    </div>
                                </div>
                            </t>
                        </t>
                    </t>

                </div>
            </div>
        </t>
    </template>

    <template id="hrmis_confirm_dismiss" name="HRMIS Confirm Dismiss (Section Officer)">
        <t t-call="hr_holidays_updates.hrmis_ui_layout">
            <div class="hrmis-panel">
                <div class="hrmis-panel__header">
                    <div class="hrmis-panel__title">Confirm dismiss</div>
                </div>
                <div class="hrmis-panel__body">
                    <div class="hrmis-kv">
                        <div class="hrmis-kv__row">
                            <div class="hrmis-kv__k">Type</div>
                            <div class="hrmis-kv__v">Leave request</div>
                        </div>
                        <div class="hrmis-kv__row">
                            <div class="hrmis-kv__k">Staff</div>
                            <div class="hrmis-kv__v"><t t-esc="record.employee_id.name"/></div>
                        </div>
                        <div class="hrmis-kv__row">
                            <div class="hrmis-kv__k">Dates</div>
                            <div class="hrmis-kv__v"><t t-esc="record.request_date_from"/> to <t t-esc="record.request_date_to"/></div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Override leave view "Back" when opened from Manage Requests -->
    <template id="hrmis_leave_view_back_section_officer" inherit_id="hr_holidays_updates.hrmis_leave_view">
        <xpath expr="//div[contains(@class,'hrmis-form__actions')]//a[contains(@class,'hrmis-btn') and contains(@class,'hrmis-btn--outline')][normalize-space()='Back']" position="attributes">
            <attribute name="t-att-href">'/hrmis/manage/requests?tab=leave' if active_menu == 'manage_requests' else '/hrmis/leave/requests'</attribute>
        </xpath>
    </template>
</odoo>
