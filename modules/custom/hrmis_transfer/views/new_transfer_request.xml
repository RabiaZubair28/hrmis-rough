<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <template id="hrmis_new_transfer_request" name="HRMIS: New Transfer Request">
        <div class="hrmis-panel__body">
            <t t-set="error" t-value="request.params.get('error')"/>
            <t t-set="success" t-value="request.params.get('success')"/>
            <t t-if="error">
                <div class="hrmis-alert hrmis-alert--error"><t t-esc="error"/></div>
            </t>
            <t t-if="success">
                <div class="hrmis-alert hrmis-alert--success"><t t-esc="success"/></div>
            </t>

            <t t-if="tab == 'new'">
                <t t-set="employee" t-value="request.env.user.employee_ids[:1]"/>
                <t t-set="districts" t-value="request.env['hrmis.district.master'].sudo().search([])"/>
                <t t-set="facilities" t-value="request.env['hrmis.facility.type'].sudo().search([])"/>
                <!-- Filter required district/facility by employee's current designation + BPS -->
                <t t-set="emp_desig" t-value="employee and getattr(employee, 'hrmis_designation', False) or False"/>
                <t t-set="emp_bps" t-value="(employee and getattr(employee, 'hrmis_bps', 0)) or 0"/>
                <t t-set="Designation" t-value="request.env['hrmis.designation'].sudo()"/>
                <t t-set="eligible_designations"
                   t-value="(emp_desig and emp_bps and ((getattr(emp_desig, 'code', False) and Designation.search([('active','=',True),('post_BPS','=',emp_bps),('code','=',emp_desig.code)])) or Designation.search([('active','=',True),('post_BPS','=',emp_bps),('name','=',emp_desig.name)]))) or Designation.browse([])"/>
                <t t-set="eligible_facilities" t-value="eligible_designations.mapped('facility_id') if eligible_designations else request.env['hrmis.facility.type'].browse([])"/>
                <t t-set="eligible_districts" t-value="eligible_facilities.mapped('district_id') if eligible_facilities else request.env['hrmis.district.master'].browse([])"/>
                <form class="hrmis-form hrmis-transfer-request-form"
                      t-att-data-employee-bps="employee.hrmis_bps"
                      t-att-action="'/hrmis/staff/%s/transfer/submit' % employee.id"
                      t-att-data-employee-id="employee.id"
                      method="post">

                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

                    <div class="hrmis-form__grid">

                        <!-- Current Posting -->
                        <div class="hrmis-field hrmis-field--wide">
                            <label>Current Posting</label>
                        </div>

                        <div class="hrmis-field">
                            <label>Current District<span class="req">*</span></label>
                            <select class="hrmis-input js-hrmis-current-district"
                                    name="current_district_id"
                                    data-hrmis-transfer-group="current"
                                    required="required">
                                <option value="">Select district</option>
                                <t t-foreach="districts" t-as="d">
                                    <option t-att-value="d.id"
                                            t-att-selected="1 if (employee and employee.district_id and employee.district_id.id == d.id) else None">
                                        <t t-esc="d.name"/>
                                    </option>
                                </t>
                            </select>
                        </div>

                        <div class="hrmis-field">
                            <label>Current Facility<span class="req">*</span></label>
                            <select class="hrmis-input js-hrmis-current-facility"
                                    name="current_facility_id"
                                    data-hrmis-transfer-group="current"
                                    required="required">
                                <option value="">Select facility</option>
                                <t t-foreach="sorted(facilities, key=lambda f: f.name)" t-as="f">
                                    <option t-att-value="f.id"
                                            t-att-data-district-id="f.district_id.id if f.district_id else ''"
                                            t-att-selected="1 if (employee and employee.facility_id and employee.facility_id.id == f.id) else None">
                                        <t t-esc="f.name"/>
                                    </option>
                                </t>
                            </select>
                        </div>

                        <!-- Required Posting -->
                        <div class="hrmis-field hrmis-field--wide">
                            <label>Required Posting</label>
                        </div>

                        <div class="hrmis-field">
                            <label>Required District<span class="req">*</span></label>
                            <select class="hrmis-input js-hrmis-required-district"
                                    name="required_district_id"
                                    data-hrmis-transfer-group="required"
                                    required="required">
                                <option value="">Select district</option>
                                <t t-if="eligible_districts">
                                    <t t-foreach="sorted(eligible_districts, key=lambda d: d.name)" t-as="d">
                                        <option t-att-value="d.id"><t t-esc="d.name"/></option>
                                    </t>
                                </t>
                            </select>
                            <t t-if="employee and emp_desig and emp_bps and not eligible_districts">
                                <div class="hrmis-help" style="margin-top:6px; color:#a00; font-weight:700;">
                                    No districts found with your designation (<t t-esc="emp_desig.name"/>) at BPS <t t-esc="emp_bps"/>.
                                </div>
                            </t>
                        </div>

                        <div class="hrmis-field">
                            <label>Required Facility<span class="req">*</span></label>
                            <select class="hrmis-input js-hrmis-required-facility"
                                    name="required_facility_id"
                                    data-hrmis-transfer-group="required"
                                    required="required">
                                <option value="">Select facility</option>
                                <t t-if="eligible_facilities">
                                    <t t-foreach="sorted(eligible_facilities, key=lambda f: f.name)" t-as="f">
                                        <option t-att-value="f.id"
                                                t-att-data-district-id="f.district_id.id if f.district_id else ''">
                                            <t t-esc="f.name"/>
                                        </option>
                                    </t>
                                </t>
                            </select>
                        </div>

                        <!-- Justification -->
                        <div class="hrmis-field hrmis-field--wide">
                            <label>Justification<span class="req">*</span></label>
                            <textarea class="hrmis-input hrmis-input--wide"
                                      name="justification"
                                      rows="4"
                                      required="required"></textarea>
                        </div>

                    </div>

                    <div class="hrmis-form__actions">
                        <button class="hrmis-btn hrmis-btn--primary hrmis-btn--lg" type="submit">
                            Submit
                        </button>
                    </div>
                </form>
            </t>
        </div>
    </template>
</odoo>